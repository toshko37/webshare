# Webshare Access Control
# =======================
# This file is served as htaccess.txt for update scripts to download
# The install script will rename it to .htaccess and update the AuthUserFile path

# Force UTF-8 encoding for all text files
AddDefaultCharset UTF-8
AddCharset UTF-8 .md .txt .json
AddType "text/plain; charset=utf-8" .md

# URL Rewriting for clean URLs
RewriteEngine On

# Rewrite /p to /p.php (preserve query string)
RewriteRule ^p$ p.php [QSA,L]

# Rewrite /upload to /upload.php
RewriteRule ^upload$ upload.php [QSA,L]

# Rewrite /u to /u.php (public upload)
RewriteRule ^u$ u.php [QSA,L]

# Rewrite /u/USERNAME to upload.php?user=USERNAME (direct user upload)
RewriteRule ^u/([a-zA-Z0-9_-]+)$ upload.php?user=$1 [QSA,L]

# Rewrite /t/TOKEN to /t.php?token=TOKEN (for viewing shared texts)
# Supports 6-64 char tokens (6=old format, 32=new secure format)
RewriteRule ^t/([a-zA-Z0-9]{6,64})$ t.php?token=$1 [QSA,L]

# Rewrite /t to /t.php (for creating texts)
RewriteRule ^t$ t.php [QSA,L]

# Rewrite /f/TOKEN to /f.php?token=TOKEN (for shared folders)
RewriteRule ^f/([a-zA-Z0-9]{6,64})$ f.php?token=$1 [QSA,L]

# Rewrite /f/TOKEN/upload for folder uploads
RewriteRule ^f/([a-zA-Z0-9]{6,64})/upload$ f.php?token=$1&action=upload [QSA,L]

# Rewrite /f/TOKEN/download for zip download
RewriteRule ^f/([a-zA-Z0-9]{6,64})/download$ f.php?token=$1&action=download [QSA,L]

# Rewrite /get to get.php (installer script)
RewriteRule ^get$ get.php [QSA,L]

# Rewrite /get-speedtest to get-speedtest.php
RewriteRule ^get-speedtest$ get-speedtest.php [QSA,L]

# Rewrite /get-update to get-update.php (remote update script)
RewriteRule ^get-update$ get-update.php [QSA,L]

# Rewrite /get-update-script to get-update-script.php (local bootstrap)
RewriteRule ^get-update-script$ get-update-script.php [QSA,L]

# Set authentication for the directory
AuthType Basic
AuthName "WebShare - Protected Area"
# NOTE: Update this path after installation!
AuthUserFile __HTPASSWD_PATH__

# Public files - no authentication required (Apache 2.4 syntax)
<FilesMatch "^(public|p|upload|u|t|f|get|get-speedtest|get-update|get-update-script|api-upload|api-scripts)\.php$">
    Require all granted
</FilesMatch>

# Version info - public (for update checks)
<FilesMatch "^version\.json$">
    Require all granted
</FilesMatch>

# htaccess.txt - public (for updates)
<FilesMatch "^htaccess\.txt$">
    Require all granted
</FilesMatch>

# user.ini.txt - public (for updates)
<FilesMatch "^user\.ini\.txt$">
    Require all granted
</FilesMatch>

# All other PHP files require authentication
<FilesMatch "^(?!public|p|upload|u|t|f|get|get-speedtest|get-update|get-update-script|api-upload|api-scripts).*\.php$">
    Require valid-user
</FilesMatch>

# Non-PHP files that need protection (except public files)
<FilesMatch "^(?!version\.json$|htaccess\.txt$|user\.ini\.txt$).*\.(json|html|htm|txt)$">
    Require valid-user
</FilesMatch>

# Security Headers
<IfModule mod_headers.c>
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
</IfModule>

# Disable directory browsing
Options -Indexes

# Protect .htaccess, .htpasswd and shell scripts
<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>

<FilesMatch "\.(sh|bash)$">
    Require all denied
</FilesMatch>

# PHP Configuration for large uploads
php_value upload_max_filesize 10G
php_value post_max_size 10G
php_value max_execution_time 7200
php_value max_input_time 7200
php_value memory_limit 512M
